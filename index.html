<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Meteor Trajectory Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <style>
        #map {
            height: 100vh;
        }

        .station-label {
            background-color: white;
            border: 1px solid #333;
            padding: 2px 4px;
            font-size: 12px;
            border-radius: 3px;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script>
        const map = L.map('map').setView([59.9, 10.75], 6);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Set to keep track of already added stations
        const addedStations = new Set();

        fetch('meteors.json')
            .then(response => response.json())
            .then(data => {
                data.forEach(event => {
                    const atm = event.AtmosphericData;
                    if (atm && atm.StartPositionNorth && atm.StartPositionEast &&
                        atm.EndPositionNorth && atm.EndPositionEast) {

                        const startLatLng = [atm.StartPositionNorth, atm.StartPositionEast];
                        const endLatLng = [atm.EndPositionNorth, atm.EndPositionEast];

                        // Add a marker at the start point of the meteor
                        L.marker(startLatLng)
                            .addTo(map)
                            .bindPopup(`ID: ${event.Id}<br>Slutthøyde: ${atm.EndHeight} km<br>Starthøyde: ${atm.StartHeight} km`);

                        // Draw trajectory line
                        L.polyline([startLatLng, endLatLng], {
                            color: 'blue',
                            weight: 2,
                            opacity: 0.8
                        }).addTo(map);
                    }

                    // Add station markers, avoiding duplicates
                    event.Observations.forEach(obs => {
                        const key = `${obs.StationCode}_${obs.StationLatitude}_${obs.StationLongitude}`;
                        if (!addedStations.has(key)) {
                            addedStations.add(key);

                            const stationLatLng = [obs.StationLatitude, obs.StationLongitude];

                            // Circle marker with label
                            L.circleMarker(stationLatLng, {
                                radius: 8,
                                color: 'red',
                                fillColor: '#a00',
                                fillOpacity: 0.7
                            }).addTo(map)
                                .bindPopup(`Stasjon: ${obs.StationCode}`);

                            // Optional: add a small label next to each station
                            L.marker(stationLatLng, {
                                icon: L.divIcon({
                                    className: 'station-label',
                                    html: obs.StationCode,
                                    iconSize: [30, 12],
                                    iconAnchor: [15, -5]
                                })
                            }).addTo(map);
                        }
                    });
                });
            })
            .catch(error => console.error('Error loading meteor data:', error));
    </script>

    <a href="https://github.com/MortenLohne/meteorkart" target="_blank"
        style="position: absolute; top: 0; right: 0; border: 0; z-index: 1000;">
        <img src="forkme_right_darkblue_121621.png" alt="Fork me on GitHub" style="width: 149px; height: auto;">
    </a>

    <div
        style="position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 5px; font-size: 16px; box-shadow: 0 0 5px rgba(0,0,0,0.2); z-index: 1000;">
        Dataen er hentet fra <a href="http://norskmeteornettverk.no"> Norsk Meteornettverk</a>, og viser meteorer
        observert i løpet av
        januar 2025.
    </div>
</body>

</html>